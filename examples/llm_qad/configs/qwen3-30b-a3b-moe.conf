#!/bin/bash
########################################################
# QAD Configuration: Qwen3-30B-A3B (MoE)
# Mixture of Experts - requires more resources
#
# Usage:
#   sbatch --nodes=8 -t 8:00:00 sbatch_qwen_qad.sh --config configs/qwen3-30b-a3b-moe.conf
########################################################

########################################################
# MODEL
########################################################
export STUDENT_MODEL="Qwen3-30B-A3B"
export TEACHER_MODEL="Qwen3-30B-A3B"

########################################################
# CHECKPOINTS (REQUIRED)
########################################################
export STUDENT_CKPT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models/Qwen3-30B-A3B-NVFP4-TP4-MLM"
export TEACHER_CKPT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models/Qwen3-30B-A3B-TP4-MLM"
export TEACHER_MODEL_CONFIG="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models/Qwen3-30B-A3B-teacher.yaml"

########################################################
# TRAINING
########################################################
export LR="1e-6"
export DATASET_NAME="nemotron"

########################################################
# PARALLELISM (MoE specific)
# Qwen3-30B-A3B: TP=4 max (num-query-groups = 4)
# With 8 GPUs: TP=4 × EP=2 = 8 GPUs total
########################################################
export TP_SIZE=4
export PP_SIZE=1
export EP_SIZE=2    # Expert parallelism: TP×EP = 4×2 = 8 GPUs
export MBS=16        # Smaller batch for larger model
export NUM_GPUS=8
export MASTER_PORT=29500

########################################################
# PATHS
########################################################
export MLM_DIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/workspace/Megatron-LM"
export MODELOPT_DIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/workspace/TensorRT-Model-Optimizer"
export MODELS_ROOT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models"
export QAD_CHECKPOINT_ROOT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/checkpoints"
export DATACACHE_DIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/data_cache"

########################################################
# CONTAINER
########################################################
export CONTAINER_IMAGE="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/containers/pytorch_25.06-py3.sqsh"
export CONTAINER_MOUNTS="/lustre/fsw:/lustre/fsw"
export CONTAINER_WORKDIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/workspace/TensorRT-Model-Optimizer/examples/llm_qad"
