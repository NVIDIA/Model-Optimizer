#!/bin/bash
########################################################
# QAD Configuration: Qwen3-30B-A3B Instruct (MoE)
# Mixture of Experts - requires more resources
#
# Usage:
#   sbatch sbatch_qwen_qad.sh --config configs/qwen3-30b-a3b-instruct-2507-moe.conf
########################################################

########################################################
# MODEL
########################################################
export STUDENT_MODEL="Qwen3-30B-A3B"
export TEACHER_MODEL="Qwen3-30B-A3B"

########################################################
# CHECKPOINTS (REQUIRED)
########################################################
# export STUDENT_CKPT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models/Qwen3-30B-A3B-Instruct-2507-NVFP4-TP4-MLM"
export STUDENT_CKPT="/home/scratch.weimingc_sw/models/modelopt_artifacts/Qwen3-30B-A3B-Instruct-2507-NVFP4-cnn_nemotron_calib-TP4-MLM"
export TEACHER_CKPT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models/Qwen3-30B-A3B-Instruct-2507-TP4-MLM"
export TEACHER_MODEL_CONFIG="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models/Qwen3-30B-A3B-Instruct-2507-teacher.yaml"

########################################################
# TRAINING
########################################################
export LR="1e-6"
export DATASET_NAME="nemotron_v2_code" #"nemotron_v2_code"
# export KD_CFG_PATH=""  # Optional: path to custom KD config YAML

########################################################
# PARALLELISM (MoE specific)
# Note: QAD loads both student + teacher models, requires more memory
########################################################
export TP_SIZE=4
export PP_SIZE=1
export EP_SIZE=4    # Expert parallelism for 128 experts
export MBS=4        
export NUM_GPUS=8
export MASTER_PORT=29500

########################################################
# PATHS
########################################################
export MLM_DIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/workspace/Megatron-LM"
export MODELOPT_DIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/workspace/TensorRT-Model-Optimizer"
export MODELS_ROOT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/models"
export QAD_CHECKPOINT_ROOT="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/checkpoints"
export DATACACHE_DIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/data_cache"

########################################################
# CONTAINER
########################################################
export CONTAINER_IMAGE="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/containers/pytorch_25.06-py3.sqsh"
export CONTAINER_MOUNTS="/lustre/fsw:/lustre/fsw"
export CONTAINER_WORKDIR="/lustre/fsw/coreai_dlalgo_modelopt/weimingc/workspace/TensorRT-Model-Optimizer/examples/llm_qad"
